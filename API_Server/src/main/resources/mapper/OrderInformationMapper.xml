<?xml version="1.0" encoding="UTF-8"?>
<!-- OrderInformationMapper.xml @author 구도원 -->
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="OrderInformationMapper">

	<resultMap id="orderList" type="com.tmon.platform.api.dto.OrderInformationDto">
		<result property="reservation_id" column="reservation_id" />
		<result property="reservation_date" column="reservation_date" />
		<result property="cancel_date" column="cancel_date" />
		<result property="user_id" column="user_id" />
		<result property="status_id" column="status_id" />
		<result property="timeslot_id" column="timeslot_id" />
		<collection property="productList" column="reservation_id"
			javaType="ArrayList" ofType="com.tmon.platform.api.dto.OrderProductDto"
			select="selectProducts" />
	</resultMap>

	<select id="selectByDate" parameterType="Map" resultMap="orderList">
		SELECT
		r.reservation_id reservation_id,
		r.reservation_date
		reservation_date,
		r.cancel_date cancel_date,
		r.user_id user_id,
		s.status_string status_string,
		r.timeslot_id timeslot_id,
		t.delivery_date delivery_date,
		t.start_time start_time,
		t.end_time
		end_time

		FROM
		RESERVATION_ORDER r

		INNER JOIN
		TIMESLOT t
		ON
		r.timeslot_id=t.timeslot_id

		INNER JOIN
		STATUS s
		ON
		r.status_id=s.status_id

		WHERE
		<![CDATA[reservation_date >= #{search_init_date} AND reservation_date < date_add(#{search_finish_date}, interval 1 day)]]>
	</select>

	<select id="selectProducts" resultType="com.tmon.platform.api.dto.OrderProductDto">
		SELECT
		o.product_id
		product_id,
		p.product_name product_name,
		o.quantity quantity,
		c.category_name category_name

		FROM
		ORDER_INFORMATION o

		INNER JOIN
		PRODUCT
		p
		ON
		o.product_id=p.product_id

		INNER JOIN
		CATEGORY c
		ON
		p.category_id=c.category_id

		WHERE
		reservation_id =
		#{reservation_id}
	</select>

	<select id="selectByDateAndUser" parameterType="Map" resultMap="orderList">

		SELECT
		r.reservation_id reservation_id,
		r.reservation_date
		reservation_date,
		r.cancel_date cancel_date,
		r.user_id user_id,
		s.status_string status_string,
		r.timeslot_id timeslot_id,
		t.delivery_date delivery_date,
		t.start_time start_time,
		t.end_time
		end_time

		FROM
		RESERVATION_ORDER r

		INNER JOIN
		TIMESLOT t
		ON
		r.timeslot_id=t.timeslot_id

		INNER JOIN
		STATUS s
		ON
		r.status_id=s.status_id

		WHERE
		<![CDATA[r.reservation_date >= #{search_init_date} AND r.reservation_date < date_add(#{search_finish_date}, interval 1 day) AND user_id = #{user_id}]]>

	</select>

</mapper>